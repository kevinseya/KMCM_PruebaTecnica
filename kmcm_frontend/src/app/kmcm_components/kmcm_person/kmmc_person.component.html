<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css">
<app-navbar></app-navbar>
<div *ngIf="persons.length > 0">
  <h2 class="table-title">Lista de Personas</h2>
  <div class="button-container" style="text-align: center;">
    <button class="btn-submit" (click)="openCreateModal()">Crear Nueva Persona</button>
  </div>
  <table class="person-table">
    <thead>
    <tr>
      <th>ID</th>
      <th>Nombre</th>
      <th>Apellido</th>
      <th>Dirección</th>
      <th>Teléfono</th>
      <th>Fecha de Nacimiento</th>
      <th>Acciones</th>
    </tr>
    </thead>
    <tbody>
    <tr *ngFor="let person of persons">
      <td>{{ person.kmcm_id }}</td>
      <td>{{ person.kmcm_name }}</td>
      <td>{{ person.kmcm_lastname }}</td>
      <td>{{ person.kmcm_address }}</td>
      <td>{{ person.kmcm_phone }}</td>
      <td>{{ person.kmcm_birthdate | date: 'shortDate' }}</td>
      <td>
        <button class="btn-edit" (click)="openEditModal(person)">Editar</button>
        <button class="btn-delete" (click)="deletePerson(person.kmcm_id)"  [disabled]="person.kmcm_id === null">Eliminar</button>
        <button class="btn-submit" (click)="getUserByIdPerson(person)" >Credenciales</button>
      </td>
    </tr>
    </tbody>
  </table>
</div>

<div *ngIf="persons.length === 0">
  <p>No hay personas disponibles.</p>
</div>

<!-- Modal para editar o crear persona -->
<div id="modalEditPerson" class="modal" *ngIf="selectedPerson && editMode">
  <div class="modal-content">
    <span class="close" (click)="closeEditModal()">&times;</span>
    <h2>{{ selectedPerson.kmcm_id ? 'Editar Persona' : 'Crear Nueva Persona' }}</h2>
    <form (ngSubmit)="savePerson()" #personForm="ngForm">
      <div class="form-group">
        <label for="name">Nombre:</label>
        <input id="name" [(ngModel)]="selectedPerson.kmcm_name" name="name" required />
        <div *ngIf="personForm.submitted && !selectedPerson.kmcm_name" class="error">
          {{ 'El nombre es obligatorio.' }}
        </div>
        <div *ngIf="selectedPerson.kmcm_name && selectedPerson.kmcm_name.length > 100" class="error">
          {{ 'El nombre no puede exceder los 100 caracteres.' }}
        </div>
      </div>
      <div class="form-group">
        <label for="lastname">Apellido:</label>
        <input id="lastname" [(ngModel)]="selectedPerson.kmcm_lastname" name="lastname" required />
        <div *ngIf="personForm.submitted && !selectedPerson.kmcm_lastname" class="error">
          {{ 'El apellido es obligatorio.' }}
        </div>
        <div *ngIf="selectedPerson.kmcm_lastname && selectedPerson.kmcm_lastname.length > 100" class="error">
          {{ 'El apellido no puede exceder los 100 caracteres.' }}
        </div>
      </div>
      <div class="form-group">
        <label for="address">Dirección:</label>
        <input id="address" [(ngModel)]="selectedPerson.kmcm_address" name="address" />
        <div *ngIf="selectedPerson.kmcm_address && selectedPerson.kmcm_address.length > 200" class="error">
          {{ 'La dirección no puede exceder los 200 caracteres.' }}
        </div>
      </div>
      <div class="form-group">
        <label for="phone">Teléfono:</label>
        <input id="phone" [(ngModel)]="selectedPerson.kmcm_phone" name="phone" required />
        <div *ngIf="personForm.submitted && !selectedPerson.kmcm_phone" class="error">
          {{ 'El número de teléfono es obligatorio.' }}
        </div>
        <div *ngIf="selectedPerson.kmcm_phone && selectedPerson.kmcm_phone.length > 15" class="error">
          {{ 'El teléfono no puede exceder los 15 caracteres.' }}
        </div>
        <div *ngIf="selectedPerson.kmcm_phone && !isPhoneValid(selectedPerson.kmcm_phone)" class="error">
          {{ 'El número de teléfono no es válido.' }}
        </div>
      </div>
      <div class="form-group">
        <label for="birthdate">Fecha de Nacimiento:</label>
        <input id="birthdate" [(ngModel)]="selectedPerson.kmcm_birthdate" name="birthdate" type="date" required />
        <div *ngIf="personForm.submitted && !selectedPerson.kmcm_birthdate" class="error">
          {{ 'La fecha de nacimiento es obligatoria.' }}
        </div>
      </div>
      <button class="btn-submit" type="submit">Guardar Cambios</button>
    </form>
  </div>
</div>


<!-- Modal Credenciales-->
<div id= "modalCredentials" class="modal" *ngIf="selectedUser && !editMode && userFlag">
  <div class="modal-content">
    <span class="close" (click)="closeUserModal()">&times;</span>
      <h2>Credenciales de Usuario</h2>
    <div class="form-group">
      <label for="username">Nombre de Usuario:</label>
      <input id="username" [(ngModel)]="selectedUser.kmcm_username" name="username" [readOnly]="editable" />
    </div>
      <div class="form-group">
        <label for="password">Contraseña:</label>
        <input
          id="password"
          [(ngModel)]="selectedUser.kmcm_password"
          name="password"

          [readOnly]="editable"
          required
          minlength="8"
          #passwordField="ngModel" />

        <div *ngIf="passwordField.invalid && (passwordField.dirty || passwordField.touched)" class="error">
          <div *ngIf="passwordField.errors?.['required']">La contraseña es obligatoria.</div>
          <div *ngIf="passwordField.errors?.['minlength']">La contraseña debe tener al menos 8 caracteres.</div>
        </div>
      </div>
  </div>
</div>
